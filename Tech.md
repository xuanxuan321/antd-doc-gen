# antd-doc-gen 实现原理

`antd-doc-gen` 是一个用于生成 Ant Design 风格组件库文档的命令行工具。它能够自动合并组件文档和示例代码，生成完整的 Markdown 文档。本文档将详细介绍其实现原理。

## 核心功能

1. **自动识别不同组件库的文档结构**
2. **合并组件文档和示例代码**
3. **生成统一格式的 Markdown 文档**
4. **创建组件文档索引**

## 实现流程

### 1. 命令行参数处理

工具使用 `commander` 库处理命令行参数，支持以下主要选项：

- `-p, --path <paths>`: 指定本地组件文档入口路径，多个路径用逗号分隔
- `-o, --output <path>`: 指定输出目录
- `-d, --download`: 从远程仓库下载代码
- `-r, --repo <url>`: 指定远程仓库地址
- `-b, --branch <branch>`: 指定分支
- `-k, --keep-temp`: 保留临时下载的代码
- `-y, --yes`: 自动确认覆盖输出目录

### 2. 代码下载

当使用 `-d` 选项时，工具会：

1. 使用 `simple-git` 库从指定仓库克隆代码
2. 将代码保存到临时目录 `.antd-temp`
3. 如果未指定 `-k` 选项，处理完成后会删除临时目录

下载逻辑包含多层容错机制：

1. 首先尝试使用指定分支（默认为 master）从 HTTPS 协议下载
2. 如果是默认分支且下载失败，尝试使用备用分支（main）
3. 如果备用分支也失败，尝试使用 SSH 协议（git@github.com）
4. 如果不是默认分支，直接尝试使用 SSH 协议

### 3. 组件文档查找

工具根据不同的仓库类型，采用不同的策略查找组件文档：

1. **ant-design 主库**：

   - 查找路径：`components/*/index.zh-CN.md`

2. **ant-design-mobile**：

   - 查找路径：`src/components/*/index.zh.md`

3. **ant-design-mini**：

   - 查找路径：`src/*/index.md`

4. **ant-design-web3**：

   - 查找路径：`packages/web3/src/*/index.zh-CN.md`

5. **ant-design/x**：
   - 查找路径：`components/*/index.zh-CN.md`

对于其他未识别的仓库，会尝试多种常见的文档路径模式。

文档查找使用 `fs` 模块直接查找文件，而不是依赖 glob 模式匹配，这样可以避免跨平台路径分隔符问题和提高查找的可靠性。

### 4. 文档解析与合并

对于每个找到的组件文档，工具会：

1. **解析文档中的示例代码引用**：

   - 使用正则表达式 `/<code\s+src="([^"]+)"[^>]*>(.*?)<\/code>/g` 查找 `<code>` 标签
   - 提取 `src` 属性和描述文本

2. **查找示例代码文件**：

   - 对于没有扩展名的路径，先尝试添加 `.tsx` 后缀
   - 如果找不到，再尝试添加 `.ts` 后缀
   - 同时查找同名的 `.md` 文件作为示例说明

3. **合并内容**：

   - 将示例代码和说明合并到主文档中
   - 如果文档中没有示例代码引用，则直接使用原始文档内容

4. **格式化组件名称**：
   - 将组件目录名转换为驼峰命名（如 `auto-complete` → `AutoComplete`）

### 5. 输出文件生成

1. **生成组件文档**：

   - 将合并后的内容写入到输出目录的 `components` 子目录中
   - 文件名格式为 `{ComponentName}.md`

2. **生成索引文件**：
   - 在输出目录根目录创建 `index.md` 文件
   - 包含所有组件的链接列表，按字母顺序排序

## 关键技术点

### 1. 智能文件路径处理

- 根据不同仓库类型自动选择正确的文档查找路径
- 处理不同操作系统的路径分隔符差异
- 自动补全缺失的文件扩展名
- 支持绝对路径和相对路径的处理

### 2. 容错机制

- 对于找不到的示例代码文件，会尝试不同的扩展名
- 对于没有示例代码的文档，直接复制原始内容
- 提供详细的错误和警告信息
- 仓库下载失败时，自动尝试不同的分支和协议

### 3. 文档格式统一

- 统一输出格式，便于阅读和使用
- 保留原始文档的结构和内容
- 将示例代码以 Markdown 代码块形式嵌入

### 4. 灵活的文档指定方式

- 可以通过 `-p` 参数直接指定要处理的文档路径
- 支持处理多个文档路径（用逗号分隔）
- 可以自动查找整个项目中的所有组件文档
- 支持从远程仓库下载代码并处理

## 技术栈

1. **Node.js 核心模块**：

   - `fs`: 文件系统操作
   - `path`: 路径处理
   - `readline`: 用户交互

2. **第三方库**：
   - `commander`: 命令行参数解析
   - `simple-git`: Git 操作
   - `chalk`: 终端彩色输出
   - `ora`: 终端加载动画
   - `glob`: 文件模式匹配（作为备用方案）
   - `rimraf`: 递归删除目录

## 扩展性

工具设计考虑了扩展性，可以通过修改代码轻松支持：

1. 新的组件库类型
2. 不同的文档结构
3. 自定义输出格式
4. 新的文档处理方式

## 局限性

1. 依赖特定的文档结构和命名约定
2. 对于非标准格式的文档可能需要手动调整
3. 示例代码必须使用 `<code>` 标签引用

## 使用场景

1. **文档生成**：将组件库的文档和示例代码合并成完整的 Markdown 文档
2. **文档迁移**：将不同组件库的文档转换为统一格式
3. **文档预览**：生成可以在本地预览的文档
4. **文档发布**：为发布到网站或其他平台准备文档
